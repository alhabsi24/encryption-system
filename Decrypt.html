<!DOCTYPE html>
<html class="dark" lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Decrypt | Military Encryption System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --glass-bg: rgba(32,49,32,0.82);
      --glass-border: rgba(168,207,69,0.22);
      --accent:#a8cf45;
      --accent-glow: 0 0 30px #a8cf45bb, 0 0 8px #a8cf45a0;
      --highlight:#5eec85;
      --danger:#ff6a6a;
    }
    html,body{
      font-family:"Roboto",sans-serif;
      background:
        url("https://images.unsplash.com/photo-1464983953574-0892a716854b?auto=format&fit=crop&w=1400&q=80") center/cover no-repeat,
        #1f2a1f;
      min-height:100vh; color:#d9e4dd;
      position:relative;
      scroll-behavior:smooth;
    }
    body::before{
      content:""; position:fixed; inset:0;
      background:rgba(31,42,31,0.93);
      z-index:0; pointer-events:none;
      backdrop-filter: blur(4px) brightness(1.1);
    }
    nav{
      backdrop-filter: blur(9px);
      background: rgba(31,47,31,0.91);
      border-bottom:2px solid var(--glass-border);
      box-shadow:0 4px 32px #a8cf4525;
      z-index:20;
    }
    .tab{
      transition:.25s;
      padding:.7rem 2.1rem; font-size:1.05rem; font-weight:800;
      border-radius:.75rem; border:2px solid transparent;
      letter-spacing:1px;
      color:#d9e4dd;
      text-decoration:none;
    }
    .tab.active,.tab:hover,.tab:focus{
      background: var(--glass-bg);
      color: var(--accent);
      border-color: var(--accent);
      box-shadow: var(--accent-glow);
      transform: translateY(-2px) scale(1.05);
      outline:none;
    }
    .card{
      background: var(--glass-bg);
      border:2px solid var(--glass-border);
      box-shadow:0 8px 40px #0008, 0 2px 12px #a8cf4522;
      backdrop-filter: blur(10px) brightness(1.06);
      border-radius: 1.5rem;
      padding: 1.5rem;
    }
    .title{
      font-size:1.6rem;
      font-weight:900;
      color:var(--accent);
      letter-spacing:.03em;
    }
    .subtitle{
      color:#9fe6b7;
      opacity:.95;
      line-height:1.6;
      margin-top:.35rem;
      font-size:.98rem;
    }
    .hr{ height:1px; background:rgba(168,207,69,0.15); margin:1rem 0; }

    .label{ font-weight:800; margin-top:1rem; display:block; color:#e5ffec; }
    .input{
      width:100%;
      background:#222f22;
      border:1.5px solid #314c31;
      border-radius:.75rem;
      padding:.85rem 1rem;
      outline:none;
      color:#e7f5dc;
    }
    .input:focus{ border-color:var(--accent); box-shadow:0 0 0 2px #a8cf4530; }

    .btn{
      background:var(--accent); color:#1f2a1f;
      border:none; border-radius:.75rem;
      padding:.95rem 1rem;
      font-weight:900; letter-spacing:1px;
      width:100%;
      transition:.2s;
      box-shadow:0 4px 18px #a8cf4539;
    }
    .btn:hover{ background:var(--highlight); transform: scale(1.02); }

    .muted{ color:#9fe6b7; opacity:.95; }
    .small{ font-size:.95rem; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .ok{ color:var(--accent); font-weight:900; }
    .bad{ color:var(--danger); font-weight:900; }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:.4rem;
      padding:.35rem .75rem;
      border-radius:999px;
      border:1px solid var(--glass-border);
      background: rgba(20,34,20,0.45);
      font-weight:900;
      letter-spacing:.02em;
    }
    .badge.ok{ color:#1f2a1f; background:rgba(168,207,69,0.9); border-color:rgba(168,207,69,0.9); }
    .badge.bad{ color:#1f2a1f; background:rgba(255,106,106,0.9); border-color:rgba(255,106,106,0.9); }

    .note{
      margin-top:.9rem;
      background: rgba(20,34,20,0.45);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: .9rem 1rem;
      color:#d7f7c6;
      line-height:1.6;
      font-size:.95rem;
    }
    ul.steps{
      margin-top:.75rem;
      display:grid;
      gap:.55rem;
    }
    ul.steps li{
      background: rgba(20,34,20,0.35);
      border: 1px solid rgba(168,207,69,0.15);
      border-radius: 12px;
      padding: .7rem .9rem;
      line-height:1.55;
    }
    code{
      background: rgba(20,34,20,0.55);
      border: 1px solid rgba(168, 207, 69, 0.25);
      padding: 0.15rem 0.35rem;
      border-radius: 8px;
      font-weight: 800;
      color: #dfffc0;
    }

    canvas.preview{
      width:100%;
      max-width:620px;
      border-radius:1rem;
      border:1px solid rgba(168,207,69,0.25);
      background:#0f160f;
    }
  </style>
</head>

<body>
  <nav class="fixed w-full py-3 px-3 flex justify-center shadow-xl">
    <div class="flex gap-6">
      <a href="index.html" class="tab">Home</a>
      <a href="encrypt.html" class="tab">Encrypt</a>
      <a href="Decrypt.html" class="tab active">Decrypt</a>
      <a href="Control.html" class="tab">Help</a>
    </div>
  </nav>

  <main class="relative z-10 px-4" style="padding-top:5.5rem; padding-bottom:3rem;">
    <div class="max-w-5xl mx-auto space-y-6">

      <!-- Decrypt Card -->
      <div class="card">
        <div class="flex items-start justify-between flex-wrap gap-3">
          <div>
            <div class="title">Decrypt (.enc) + Verify Integrity</div>
            <div class="subtitle">
              Upload the <b>.enc</b> file generated from <code>encrypt.html</code> and enter the <b>same key</b>.
              You will get the original image back and an integrity check status (Verified / Failed).
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
          <!-- Left: inputs -->
          <form id="decrypt-form" class="space-y-2">
            <label class="label" for="file-input">Encrypted File (.enc)</label>
            <input class="input" type="file" id="file-input" accept=".enc,application/octet-stream" required />

            <label class="label" for="key-input">Decryption Key</label>
            <input class="input" type="password" id="key-input" minlength="6" maxlength="64" placeholder="same key used in Encrypt" required />

            <div class="mt-4">
              <button class="btn" type="submit">Decrypt + Download PNG</button>
            </div>

            <div id="message" class="mt-4 small"></div>

            <div class="note">
              <b>Important:</b>
              Keep your encrypted output as <code>.enc</code>.
              If you convert/edit/compress the encrypted data using external tools, verification may fail.
            </div>

            <div class="mt-4">
              <div class="muted small font-bold">Quick Steps</div>
              <ul class="steps">
                <li><b>1)</b> Go to <code>encrypt.html</code> → encrypt an image → download <code>.enc</code></li>
                <li><b>2)</b> Come here → upload that <code>.enc</code></li>
                <li><b>3)</b> Enter the same key → decrypt → download PNG</li>
              </ul>
            </div>
          </form>

          <!-- Right: preview -->
          <div>
            <div class="muted mb-2 small">Decrypted Preview</div>
            <canvas id="cv-dec" class="preview"></canvas>
          </div>
        </div>
      </div>

      <!-- Verification -->
      <div class="card">
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <div>
            <div class="text-xl font-black" style="color:var(--accent)">Verification Result</div>
            <div class="subtitle">
              We compare <code>SHA-256(original RGB)</code> stored inside the <code>.enc</code> file
              with <code>SHA-256(decrypted RGB)</code>.
            </div>
          </div>
          <div id="status-badge" class="badge" style="display:none;"></div>
        </div>

        <div class="hr"></div>
        <div class="mono small" id="verify-box">—</div>
      </div>

    </div>
  </main>

<script>
/* ===================== Core Params ===================== */
const R = 3.99;

/* ===================== Helpers ===================== */
function clamp01(x){ return Math.min(0.999999999999, Math.max(1e-12, x)); }
function encUtf8(str){ return new TextEncoder().encode(str); }

async function sha256(bytes){
  const buf = await crypto.subtle.digest("SHA-256", bytes);
  return new Uint8Array(buf);
}

// password -> x0 (0,1) deterministic
async function passwordToX0(password, label){
  const h = await sha256(encUtf8(password + "|" + label));
  const v = (h[0]<<24) | (h[1]<<16) | (h[2]<<8) | (h[3]);
  const u = (v >>> 0);
  const x0 = (u + 1) / (2**32 + 2);
  return clamp01(x0);
}

function logisticKeysUint32(N, x0, r){
  const keys = new Uint32Array(N);
  let x = x0;
  for(let i=0;i<N;i++){
    x = r * x * (1 - x);
    keys[i] = (Math.floor(x * 4294967296) >>> 0);
  }
  return keys;
}

// Stable radix sort indices by keys (uint32)
function radixSortIndicesByKeys(keys){
  const N = keys.length;
  let idx = new Uint32Array(N);
  let tmp = new Uint32Array(N);
  for(let i=0;i<N;i++) idx[i] = i;

  const counts = new Uint32Array(256);

  for(let pass=0; pass<4; pass++){
    const shift = pass * 8;
    counts.fill(0);

    for(let i=0;i<N;i++){
      const k = (keys[idx[i]] >>> shift) & 255;
      counts[k]++;
    }

    let sum = 0;
    for(let i=0;i<256;i++){
      const c = counts[i];
      counts[i] = sum;
      sum += c;
    }

    for(let i=0;i<N;i++){
      const v = idx[i];
      const k = (keys[v] >>> shift) & 255;
      tmp[counts[k]++] = v;
    }

    const swap = idx; idx = tmp; tmp = swap;
  }
  return idx; // permutation: dst i takes src idx[i]
}

function invertPermutation(perm){
  const inv = new Uint32Array(perm.length);
  for(let i=0;i<perm.length;i++) inv[perm[i]] = i;
  return inv;
}

function rgbaToRgbBytes(rgba){
  const N = rgba.length / 4;
  const rgb = new Uint8Array(N*3);
  for(let i=0;i<N;i++){
    rgb[i*3]   = rgba[i*4];
    rgb[i*3+1] = rgba[i*4+1];
    rgb[i*3+2] = rgba[i*4+2];
  }
  return rgb;
}

function rgbToRgba(rgb, alpha=255){
  const N = rgb.length/3;
  const rgba = new Uint8ClampedArray(N*4);
  for(let i=0;i<N;i++){
    rgba[i*4]   = rgb[i*3];
    rgba[i*4+1] = rgb[i*3+1];
    rgba[i*4+2] = rgb[i*3+2];
    rgba[i*4+3] = alpha;
  }
  return rgba;
}

function unscrambleRGBA(scrambledRGBA, invPerm){
  const N = invPerm.length;
  const out = new Uint8ClampedArray(N*4);
  for(let i=0;i<N;i++){
    const s = invPerm[i]*4;
    const d = i*4;
    out[d]   = scrambledRGBA[s];
    out[d+1] = scrambledRGBA[s+1];
    out[d+2] = scrambledRGBA[s+2];
    out[d+3] = scrambledRGBA[s+3];
  }
  return out;
}

// Diffusion: per byte XOR mask built from 8 chaos bits (MSB->LSB)
// XOR is its own inverse => same function for encrypt/decrypt
function xorDiffusionBytes(bytes, x0, r){
  const out = new Uint8Array(bytes.length);
  let x = x0;
  for(let i=0;i<bytes.length;i++){
    let mask = 0;
    for(let b=7;b>=0;b--){
      x = r * x * (1 - x);
      const bit = (Math.floor(x * 1e14) % 2) & 1;
      mask |= (bit << b);
    }
    out[i] = bytes[i] ^ mask;
  }
  return out;
}

function drawImageToCanvas(canvas, rgba, w, h){
  canvas.width = w;
  canvas.height = h;
  const ctx = canvas.getContext("2d", { willReadFrequently:true });
  ctx.putImageData(new ImageData(new Uint8ClampedArray(rgba), w, h), 0, 0);

  // fit css
  const ratio = w/h;
  const cssW = Math.min(620, w);
  canvas.style.width = cssW + "px";
  canvas.style.height = (cssW/ratio) + "px";
}

function downloadBlob(blob, filename){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 600);
}

function bytesToHex(u){
  return Array.from(u).map(b=>b.toString(16).padStart(2,"0")).join("");
}

/* ===================== .enc File Format =====================
   magic(4) = 'MES1'
   ver(1)   = 1
   width(4) uint32 LE
   height(4)uint32 LE
   flags(1) bit0=alpha(1)
   origHash(32) SHA256 of ORIGINAL RGB bytes
   encRGBA (width*height*4 bytes) encrypted RGBA (alpha fixed=255)
============================================================== */
function parseEncFile(arrayBuffer){
  const dv = new DataView(arrayBuffer);
  let o=0;

  const m0 = dv.getUint8(o++), m1 = dv.getUint8(o++), m2 = dv.getUint8(o++), m3 = dv.getUint8(o++);
  const magic = String.fromCharCode(m0,m1,m2,m3);
  if(magic !== "MES1") throw new Error("Invalid file: magic mismatch.");

  const ver = dv.getUint8(o++);
  if(ver !== 1) throw new Error("Unsupported version: " + ver);

  const w = dv.getUint32(o, true); o+=4;
  const h = dv.getUint32(o, true); o+=4;

  const flags = dv.getUint8(o++);
  const hasAlpha = (flags & 1) === 1;

  const origHash = new Uint8Array(arrayBuffer, o, 32); o += 32;

  const encRGBA = new Uint8ClampedArray(arrayBuffer, o);
  const expectedLen = w*h*4;
  if(encRGBA.length !== expectedLen) throw new Error("Corrupted file: data length mismatch.");

  return { w, h, hasAlpha, origHash: new Uint8Array(origHash), encRGBA };
}

/* ===================== UI ===================== */
document.getElementById("decrypt-form").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const msg = document.getElementById("message");
  const verifyBox = document.getElementById("verify-box");
  const badge = document.getElementById("status-badge");

  msg.innerHTML = "";
  verifyBox.textContent = "—";
  badge.style.display = "none";
  badge.className = "badge";

  const file = document.getElementById("file-input").files[0];
  const password = document.getElementById("key-input").value;

  if(!file || password.length < 6){
    msg.innerHTML = `<div class="bad">Please select a .enc file and enter a key (min 6 characters).</div>`;
    return;
  }

  try{
    const buf = await file.arrayBuffer();
    const parsed = parseEncFile(buf);

    const W = parsed.w, H = parsed.h;
    const N = W*H;

    // derive seeds
    const x0_scr = await passwordToX0(password, "scramble");
    const x0_dif = await passwordToX0(password, "diffuse");

    // regenerate permutation
    const keys = logisticKeysUint32(N, x0_scr, R);
    const perm = radixSortIndicesByKeys(keys);
    const invPerm = invertPermutation(perm);

    // reverse diffusion on RGB (XOR again)
    const encRGB = rgbaToRgbBytes(parsed.encRGBA);
    const scrRGB = xorDiffusionBytes(encRGB, x0_dif, R);

    // rebuild scrambled RGBA then reverse scrambling
    const scrRGBA = rgbToRgba(scrRGB, 255);
    const decRGBA = unscrambleRGBA(scrRGBA, invPerm);

    // render
    drawImageToCanvas(document.getElementById("cv-dec"), decRGBA, W, H);

    // verify hash
    const decRGB = rgbaToRgbBytes(decRGBA);
    const decHash = await sha256(decRGB);

    let same = true;
    for(let i=0;i<32;i++){
      if(decHash[i] !== parsed.origHash[i]){ same=false; break; }
    }

    const storedHex = bytesToHex(parsed.origHash);
    const decHex = bytesToHex(decHash);

    verifyBox.innerHTML =
      `Stored Hash (original RGB): <span class="mono">${storedHex}</span><br>` +
      `Decrypted Hash (RGB):       <span class="mono">${decHex}</span><br><br>` +
      (same
        ? `<span class="ok">VERIFIED ✅ Decrypted image matches the original (pixel-level RGB).</span>`
        : `<span class="bad">FAILED ❌ Wrong key or file was modified/compressed externally.</span>`
      );

    badge.style.display = "inline-flex";
    if(same){
      badge.className = "badge ok";
      badge.textContent = "VERIFIED";
    }else{
      badge.className = "badge bad";
      badge.textContent = "FAILED";
    }

    msg.innerHTML =
      `<div class="ok">Decryption complete ✅</div>
       <div class="muted small mt-2">
         <a href="#" id="dl" class="mono" style="color:var(--highlight); text-decoration:underline;">
           Download Decrypted PNG
         </a>
       </div>`;

    document.getElementById("dl").onclick = (ev)=>{
      ev.preventDefault();
      const cv = document.getElementById("cv-dec");
      const outName = file.name.replace(/\.enc$/i,"") + "_decrypted.png";
      cv.toBlob((blob)=> downloadBlob(blob, outName), "image/png");
    };

  }catch(err){
    msg.innerHTML = `<div class="bad">Error: ${String(err)}</div>`;
  }
});
</script>
</body>
</html>
